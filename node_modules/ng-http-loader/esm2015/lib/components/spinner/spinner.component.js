/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
/*
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS
 * FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR
 * COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER
 * IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
 * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */
import { Component, Input } from '@angular/core';
import { EMPTY, merge, timer } from 'rxjs';
import { debounce, delayWhen } from 'rxjs/operators';
import { PendingInterceptorService } from '../../services/pending-interceptor.service';
import { SpinnerVisibilityService } from '../../services/spinner-visibility.service';
import { Spinkit } from '../../spinkits';
export class SpinnerComponent {
    /**
     * @param {?} pendingInterceptorService
     * @param {?} spinnerVisibilityService
     */
    constructor(pendingInterceptorService, spinnerVisibilityService) {
        this.pendingInterceptorService = pendingInterceptorService;
        this.spinnerVisibilityService = spinnerVisibilityService;
        this.spinkit = Spinkit;
        this.spinner = Spinkit.skCubeGrid;
        this.filteredUrlPatterns = [];
        this.debounceDelay = 0;
        this.minDuration = 0;
        this.entryComponent = null;
        this.subscriptions = merge(this.pendingInterceptorService.pendingRequestsStatus$.pipe(debounce(this.handleDebounceDelay.bind(this)), delayWhen(this.handleMinDuration.bind(this))), this.spinnerVisibilityService.visibilityObservable$)
            .subscribe(this.handleSpinnerVisibility().bind(this));
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        this.nullifySpinnerIfComponentOutletIsDefined();
        if (!(this.filteredUrlPatterns instanceof Array)) {
            throw new TypeError('`filteredUrlPatterns` must be an array.');
        }
        if (!!this.filteredUrlPatterns.length) {
            this.filteredUrlPatterns.forEach(e => {
                this.pendingInterceptorService.filteredUrlPatterns.push(new RegExp(e));
            });
        }
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        this.subscriptions.unsubscribe();
    }
    /**
     * @return {?}
     */
    nullifySpinnerIfComponentOutletIsDefined() {
        if (null != this.entryComponent) {
            this.spinner = null;
        }
    }
    /**
     * @return {?}
     */
    handleSpinnerVisibility() {
        return v => this.isSpinnerVisible = v;
    }
    /**
     * @param {?} hasPendingRequests
     * @return {?}
     */
    handleDebounceDelay(hasPendingRequests) {
        if (hasPendingRequests && !!this.debounceDelay) {
            return timer(this.debounceDelay);
        }
        return EMPTY;
    }
    /**
     * @param {?} hasPendingRequests
     * @return {?}
     */
    handleMinDuration(hasPendingRequests) {
        if (hasPendingRequests || !this.minDuration) {
            this.startTime = Date.now();
            return timer(0);
        }
        const /** @type {?} */ timerObservable = timer(this.minDuration - (Date.now() - this.startTime));
        this.startTime = null;
        return timerObservable;
    }
}
SpinnerComponent.decorators = [
    { type: Component, args: [{
                selector: 'spinner',
                template: `<div id="spinner" *ngIf="isSpinnerVisible">

    <ng-container *ngComponentOutlet="entryComponent"></ng-container>

    <sk-cube-grid
        *ngIf="spinner === spinkit.skCubeGrid"
        [backgroundColor]="backgroundColor">
    </sk-cube-grid>

    <sk-chasing-dots
        *ngIf="spinner === spinkit.skChasingDots"
        [backgroundColor]="backgroundColor">
    </sk-chasing-dots>

    <sk-double-bounce
        *ngIf="spinner === spinkit.skDoubleBounce"
        [backgroundColor]="backgroundColor">
    </sk-double-bounce>

    <sk-rotating-plane
        *ngIf="spinner === spinkit.skRotatingPlane"
        [backgroundColor]="backgroundColor">
    </sk-rotating-plane>

    <sk-spinner-pulse
        *ngIf="spinner === spinkit.skSpinnerPulse"
        [backgroundColor]="backgroundColor">
    </sk-spinner-pulse>

    <sk-three-bounce
        *ngIf="spinner === spinkit.skThreeBounce"
        [backgroundColor]="backgroundColor">
    </sk-three-bounce>

    <sk-wandering-cubes
        *ngIf="spinner === spinkit.skWanderingCubes"
        [backgroundColor]="backgroundColor">
    </sk-wandering-cubes>

    <sk-wave
        *ngIf="spinner === spinkit.skWave"
        [backgroundColor]="backgroundColor">
    </sk-wave>

</div>

`,
                styles: [`#spinner{top:0;left:0;height:100%;width:100%;position:fixed;z-index:9999;opacity:.7;background-color:#f1f1f1;display:flex;align-items:center;justify-content:center}::ng-deep .colored-parent,::ng-deep .colored>div{background-color:#333}`]
            },] },
];
/** @nocollapse */
SpinnerComponent.ctorParameters = () => [
    { type: PendingInterceptorService, },
    { type: SpinnerVisibilityService, },
];
SpinnerComponent.propDecorators = {
    "backgroundColor": [{ type: Input },],
    "spinner": [{ type: Input },],
    "filteredUrlPatterns": [{ type: Input },],
    "debounceDelay": [{ type: Input },],
    "minDuration": [{ type: Input },],
    "entryComponent": [{ type: Input },],
};
function SpinnerComponent_tsickle_Closure_declarations() {
    /** @type {!Array<{type: !Function, args: (undefined|!Array<?>)}>} */
    SpinnerComponent.decorators;
    /**
     * @nocollapse
     * @type {function(): !Array<(null|{type: ?, decorators: (undefined|!Array<{type: !Function, args: (undefined|!Array<?>)}>)})>}
     */
    SpinnerComponent.ctorParameters;
    /** @type {!Object<string,!Array<{type: !Function, args: (undefined|!Array<?>)}>>} */
    SpinnerComponent.propDecorators;
    /** @type {?} */
    SpinnerComponent.prototype.isSpinnerVisible;
    /** @type {?} */
    SpinnerComponent.prototype.spinkit;
    /** @type {?} */
    SpinnerComponent.prototype.subscriptions;
    /** @type {?} */
    SpinnerComponent.prototype.startTime;
    /** @type {?} */
    SpinnerComponent.prototype.backgroundColor;
    /** @type {?} */
    SpinnerComponent.prototype.spinner;
    /** @type {?} */
    SpinnerComponent.prototype.filteredUrlPatterns;
    /** @type {?} */
    SpinnerComponent.prototype.debounceDelay;
    /** @type {?} */
    SpinnerComponent.prototype.minDuration;
    /** @type {?} */
    SpinnerComponent.prototype.entryComponent;
    /** @type {?} */
    SpinnerComponent.prototype.pendingInterceptorService;
    /** @type {?} */
    SpinnerComponent.prototype.spinnerVisibilityService;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3Bpbm5lci5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZy1odHRwLWxvYWRlci8iLCJzb3VyY2VzIjpbImxpYi9jb21wb25lbnRzL3NwaW5uZXIvc3Bpbm5lci5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7O0FBU0EsT0FBTyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQXFCLE1BQU0sZUFBZSxDQUFDO0FBQ3BFLE9BQU8sRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUE0QixLQUFLLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDckUsT0FBTyxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNyRCxPQUFPLEVBQUUseUJBQXlCLEVBQUUsTUFBTSw0Q0FBNEMsQ0FBQztBQUN2RixPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSwyQ0FBMkMsQ0FBQztBQUNyRixPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFxRHpDLE1BQU07Ozs7O0lBbUJGLFlBQW9CLHlCQUFvRCxFQUFVLHdCQUFrRDtRQUFoSCw4QkFBeUIsR0FBekIseUJBQXlCLENBQTJCO1FBQVUsNkJBQXdCLEdBQXhCLHdCQUF3QixDQUEwQjt1QkFqQm5ILE9BQU87dUJBT1AsT0FBTyxDQUFDLFVBQVU7bUNBRUksRUFBRTs2QkFFbEIsQ0FBQzsyQkFFSCxDQUFDOzhCQUVPLElBQUk7UUFHN0IsSUFBSSxDQUFDLGFBQWEsR0FBRyxLQUFLLENBQ3RCLElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxzQkFBc0IsQ0FBQyxJQUFJLENBQ3RELFFBQVEsQ0FBQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLEVBQzdDLFNBQVMsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQy9DLEVBQ0QsSUFBSSxDQUFDLHdCQUF3QixDQUFDLHFCQUFxQixDQUN0RDthQUNJLFNBQVMsQ0FBQyxJQUFJLENBQUMsdUJBQXVCLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztLQUM3RDs7OztJQUVELFFBQVE7UUFDSixJQUFJLENBQUMsd0NBQXdDLEVBQUUsQ0FBQztRQUVoRCxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLG1CQUFtQixZQUFZLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUMvQyxNQUFNLElBQUksU0FBUyxDQUFDLHlDQUF5QyxDQUFDLENBQUM7U0FDbEU7UUFFRCxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7WUFDcEMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRTtnQkFDakMsSUFBSSxDQUFDLHlCQUF5QixDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxJQUFJLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2FBQzFFLENBQUMsQ0FBQztTQUNOO0tBQ0o7Ozs7SUFFRCxXQUFXO1FBQ1AsSUFBSSxDQUFDLGFBQWEsQ0FBQyxXQUFXLEVBQUUsQ0FBQztLQUNwQzs7OztJQUVPLHdDQUF3QztRQUM1QyxFQUFFLENBQUMsQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUM7WUFDOUIsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUM7U0FDdkI7Ozs7O0lBR0csdUJBQXVCO1FBQzNCLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxDQUFDLENBQUM7Ozs7OztJQUdsQyxtQkFBbUIsQ0FBQyxrQkFBMkI7UUFDbkQsRUFBRSxDQUFDLENBQUMsa0JBQWtCLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDO1lBQzdDLE1BQU0sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1NBQ3BDO1FBRUQsTUFBTSxDQUFDLEtBQUssQ0FBQzs7Ozs7O0lBR1QsaUJBQWlCLENBQUMsa0JBQTJCO1FBQ2pELEVBQUUsQ0FBQyxDQUFDLGtCQUFrQixJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUM7WUFDMUMsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7WUFFNUIsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUNuQjtRQUVELHVCQUFNLGVBQWUsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLFdBQVcsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQztRQUNoRixJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQztRQUV0QixNQUFNLENBQUMsZUFBZSxDQUFDOzs7O1lBL0g5QixTQUFTLFNBQUM7Z0JBQ1AsUUFBUSxFQUFFLFNBQVM7Z0JBQ25CLFFBQVEsRUFBRTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztDQThDYjtnQkFDRyxNQUFNLEVBQUUsQ0FBQyw2T0FBNk8sQ0FBQzthQUMxUDs7OztZQXREUSx5QkFBeUI7WUFDekIsd0JBQXdCOzs7Z0NBNEQ1QixLQUFLO3dCQUVMLEtBQUs7b0NBRUwsS0FBSzs4QkFFTCxLQUFLOzRCQUVMLEtBQUs7K0JBRUwsS0FBSyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgXCJBUyBJU1wiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SXG4gKiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwgRklUTkVTU1xuICogRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRSBBVVRIT1JTIE9SXG4gKiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUiBMSUFCSUxJVFksIFdIRVRIRVJcbiAqIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwgT1VUIE9GIE9SIElOXG4gKiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFIFNPRlRXQVJFLlxuICovXG5cbmltcG9ydCB7IENvbXBvbmVudCwgSW5wdXQsIE9uRGVzdHJveSwgT25Jbml0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBFTVBUWSwgbWVyZ2UsIE9ic2VydmFibGUsIFN1YnNjcmlwdGlvbiwgdGltZXIgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGRlYm91bmNlLCBkZWxheVdoZW4gfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBQZW5kaW5nSW50ZXJjZXB0b3JTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vc2VydmljZXMvcGVuZGluZy1pbnRlcmNlcHRvci5zZXJ2aWNlJztcbmltcG9ydCB7IFNwaW5uZXJWaXNpYmlsaXR5U2VydmljZSB9IGZyb20gJy4uLy4uL3NlcnZpY2VzL3NwaW5uZXItdmlzaWJpbGl0eS5zZXJ2aWNlJztcbmltcG9ydCB7IFNwaW5raXQgfSBmcm9tICcuLi8uLi9zcGlua2l0cyc7XG5cbkBDb21wb25lbnQoe1xuICAgIHNlbGVjdG9yOiAnc3Bpbm5lcicsXG4gICAgdGVtcGxhdGU6IGA8ZGl2IGlkPVwic3Bpbm5lclwiICpuZ0lmPVwiaXNTcGlubmVyVmlzaWJsZVwiPlxuXG4gICAgPG5nLWNvbnRhaW5lciAqbmdDb21wb25lbnRPdXRsZXQ9XCJlbnRyeUNvbXBvbmVudFwiPjwvbmctY29udGFpbmVyPlxuXG4gICAgPHNrLWN1YmUtZ3JpZFxuICAgICAgICAqbmdJZj1cInNwaW5uZXIgPT09IHNwaW5raXQuc2tDdWJlR3JpZFwiXG4gICAgICAgIFtiYWNrZ3JvdW5kQ29sb3JdPVwiYmFja2dyb3VuZENvbG9yXCI+XG4gICAgPC9zay1jdWJlLWdyaWQ+XG5cbiAgICA8c2stY2hhc2luZy1kb3RzXG4gICAgICAgICpuZ0lmPVwic3Bpbm5lciA9PT0gc3BpbmtpdC5za0NoYXNpbmdEb3RzXCJcbiAgICAgICAgW2JhY2tncm91bmRDb2xvcl09XCJiYWNrZ3JvdW5kQ29sb3JcIj5cbiAgICA8L3NrLWNoYXNpbmctZG90cz5cblxuICAgIDxzay1kb3VibGUtYm91bmNlXG4gICAgICAgICpuZ0lmPVwic3Bpbm5lciA9PT0gc3BpbmtpdC5za0RvdWJsZUJvdW5jZVwiXG4gICAgICAgIFtiYWNrZ3JvdW5kQ29sb3JdPVwiYmFja2dyb3VuZENvbG9yXCI+XG4gICAgPC9zay1kb3VibGUtYm91bmNlPlxuXG4gICAgPHNrLXJvdGF0aW5nLXBsYW5lXG4gICAgICAgICpuZ0lmPVwic3Bpbm5lciA9PT0gc3BpbmtpdC5za1JvdGF0aW5nUGxhbmVcIlxuICAgICAgICBbYmFja2dyb3VuZENvbG9yXT1cImJhY2tncm91bmRDb2xvclwiPlxuICAgIDwvc2stcm90YXRpbmctcGxhbmU+XG5cbiAgICA8c2stc3Bpbm5lci1wdWxzZVxuICAgICAgICAqbmdJZj1cInNwaW5uZXIgPT09IHNwaW5raXQuc2tTcGlubmVyUHVsc2VcIlxuICAgICAgICBbYmFja2dyb3VuZENvbG9yXT1cImJhY2tncm91bmRDb2xvclwiPlxuICAgIDwvc2stc3Bpbm5lci1wdWxzZT5cblxuICAgIDxzay10aHJlZS1ib3VuY2VcbiAgICAgICAgKm5nSWY9XCJzcGlubmVyID09PSBzcGlua2l0LnNrVGhyZWVCb3VuY2VcIlxuICAgICAgICBbYmFja2dyb3VuZENvbG9yXT1cImJhY2tncm91bmRDb2xvclwiPlxuICAgIDwvc2stdGhyZWUtYm91bmNlPlxuXG4gICAgPHNrLXdhbmRlcmluZy1jdWJlc1xuICAgICAgICAqbmdJZj1cInNwaW5uZXIgPT09IHNwaW5raXQuc2tXYW5kZXJpbmdDdWJlc1wiXG4gICAgICAgIFtiYWNrZ3JvdW5kQ29sb3JdPVwiYmFja2dyb3VuZENvbG9yXCI+XG4gICAgPC9zay13YW5kZXJpbmctY3ViZXM+XG5cbiAgICA8c2std2F2ZVxuICAgICAgICAqbmdJZj1cInNwaW5uZXIgPT09IHNwaW5raXQuc2tXYXZlXCJcbiAgICAgICAgW2JhY2tncm91bmRDb2xvcl09XCJiYWNrZ3JvdW5kQ29sb3JcIj5cbiAgICA8L3NrLXdhdmU+XG5cbjwvZGl2PlxuXG5gLFxuICAgIHN0eWxlczogW2Ajc3Bpbm5lcnt0b3A6MDtsZWZ0OjA7aGVpZ2h0OjEwMCU7d2lkdGg6MTAwJTtwb3NpdGlvbjpmaXhlZDt6LWluZGV4Ojk5OTk7b3BhY2l0eTouNztiYWNrZ3JvdW5kLWNvbG9yOiNmMWYxZjE7ZGlzcGxheTpmbGV4O2FsaWduLWl0ZW1zOmNlbnRlcjtqdXN0aWZ5LWNvbnRlbnQ6Y2VudGVyfTo6bmctZGVlcCAuY29sb3JlZC1wYXJlbnQsOjpuZy1kZWVwIC5jb2xvcmVkPmRpdntiYWNrZ3JvdW5kLWNvbG9yOiMzMzN9YF1cbn0pXG5leHBvcnQgY2xhc3MgU3Bpbm5lckNvbXBvbmVudCBpbXBsZW1lbnRzIE9uRGVzdHJveSwgT25Jbml0IHtcbiAgICBwdWJsaWMgaXNTcGlubmVyVmlzaWJsZTogYm9vbGVhbjtcbiAgICBwdWJsaWMgc3BpbmtpdCA9IFNwaW5raXQ7XG4gICAgcHJpdmF0ZSBzdWJzY3JpcHRpb25zOiBTdWJzY3JpcHRpb247XG4gICAgcHJpdmF0ZSBzdGFydFRpbWU6IG51bWJlcjtcblxuICAgIEBJbnB1dCgpXG4gICAgcHVibGljIGJhY2tncm91bmRDb2xvcjogc3RyaW5nO1xuICAgIEBJbnB1dCgpXG4gICAgcHVibGljIHNwaW5uZXIgPSBTcGlua2l0LnNrQ3ViZUdyaWQ7XG4gICAgQElucHV0KClcbiAgICBwdWJsaWMgZmlsdGVyZWRVcmxQYXR0ZXJuczogc3RyaW5nW10gPSBbXTtcbiAgICBASW5wdXQoKVxuICAgIHB1YmxpYyBkZWJvdW5jZURlbGF5ID0gMDtcbiAgICBASW5wdXQoKVxuICAgIHB1YmxpYyBtaW5EdXJhdGlvbiA9IDA7XG4gICAgQElucHV0KClcbiAgICBwdWJsaWMgZW50cnlDb21wb25lbnQ6IGFueSA9IG51bGw7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIHBlbmRpbmdJbnRlcmNlcHRvclNlcnZpY2U6IFBlbmRpbmdJbnRlcmNlcHRvclNlcnZpY2UsIHByaXZhdGUgc3Bpbm5lclZpc2liaWxpdHlTZXJ2aWNlOiBTcGlubmVyVmlzaWJpbGl0eVNlcnZpY2UpIHtcbiAgICAgICAgdGhpcy5zdWJzY3JpcHRpb25zID0gbWVyZ2UoXG4gICAgICAgICAgICB0aGlzLnBlbmRpbmdJbnRlcmNlcHRvclNlcnZpY2UucGVuZGluZ1JlcXVlc3RzU3RhdHVzJC5waXBlKFxuICAgICAgICAgICAgICAgIGRlYm91bmNlKHRoaXMuaGFuZGxlRGVib3VuY2VEZWxheS5iaW5kKHRoaXMpKSxcbiAgICAgICAgICAgICAgICBkZWxheVdoZW4odGhpcy5oYW5kbGVNaW5EdXJhdGlvbi5iaW5kKHRoaXMpKVxuICAgICAgICAgICAgKSxcbiAgICAgICAgICAgIHRoaXMuc3Bpbm5lclZpc2liaWxpdHlTZXJ2aWNlLnZpc2liaWxpdHlPYnNlcnZhYmxlJCxcbiAgICAgICAgKVxuICAgICAgICAgICAgLnN1YnNjcmliZSh0aGlzLmhhbmRsZVNwaW5uZXJWaXNpYmlsaXR5KCkuYmluZCh0aGlzKSk7XG4gICAgfVxuXG4gICAgbmdPbkluaXQoKTogdm9pZCB7XG4gICAgICAgIHRoaXMubnVsbGlmeVNwaW5uZXJJZkNvbXBvbmVudE91dGxldElzRGVmaW5lZCgpO1xuXG4gICAgICAgIGlmICghKHRoaXMuZmlsdGVyZWRVcmxQYXR0ZXJucyBpbnN0YW5jZW9mIEFycmF5KSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignYGZpbHRlcmVkVXJsUGF0dGVybnNgIG11c3QgYmUgYW4gYXJyYXkuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoISF0aGlzLmZpbHRlcmVkVXJsUGF0dGVybnMubGVuZ3RoKSB7XG4gICAgICAgICAgICB0aGlzLmZpbHRlcmVkVXJsUGF0dGVybnMuZm9yRWFjaChlID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLnBlbmRpbmdJbnRlcmNlcHRvclNlcnZpY2UuZmlsdGVyZWRVcmxQYXR0ZXJucy5wdXNoKG5ldyBSZWdFeHAoZSkpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5zdWJzY3JpcHRpb25zLnVuc3Vic2NyaWJlKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBudWxsaWZ5U3Bpbm5lcklmQ29tcG9uZW50T3V0bGV0SXNEZWZpbmVkKCk6IHZvaWQge1xuICAgICAgICBpZiAobnVsbCAhPSB0aGlzLmVudHJ5Q29tcG9uZW50KSB7XG4gICAgICAgICAgICB0aGlzLnNwaW5uZXIgPSBudWxsO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBoYW5kbGVTcGlubmVyVmlzaWJpbGl0eSgpOiAodjogYm9vbGVhbikgPT4gdm9pZCB7XG4gICAgICAgIHJldHVybiB2ID0+IHRoaXMuaXNTcGlubmVyVmlzaWJsZSA9IHY7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBoYW5kbGVEZWJvdW5jZURlbGF5KGhhc1BlbmRpbmdSZXF1ZXN0czogYm9vbGVhbik6IE9ic2VydmFibGU8bnVtYmVyIHwgbmV2ZXI+IHtcbiAgICAgICAgaWYgKGhhc1BlbmRpbmdSZXF1ZXN0cyAmJiAhIXRoaXMuZGVib3VuY2VEZWxheSkge1xuICAgICAgICAgICAgcmV0dXJuIHRpbWVyKHRoaXMuZGVib3VuY2VEZWxheSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gRU1QVFk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBoYW5kbGVNaW5EdXJhdGlvbihoYXNQZW5kaW5nUmVxdWVzdHM6IGJvb2xlYW4pOiBPYnNlcnZhYmxlPG51bWJlcj4ge1xuICAgICAgICBpZiAoaGFzUGVuZGluZ1JlcXVlc3RzIHx8ICF0aGlzLm1pbkR1cmF0aW9uKSB7XG4gICAgICAgICAgICB0aGlzLnN0YXJ0VGltZSA9IERhdGUubm93KCk7XG5cbiAgICAgICAgICAgIHJldHVybiB0aW1lcigwKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHRpbWVyT2JzZXJ2YWJsZSA9IHRpbWVyKHRoaXMubWluRHVyYXRpb24gLSAoRGF0ZS5ub3coKSAtIHRoaXMuc3RhcnRUaW1lKSk7XG4gICAgICAgIHRoaXMuc3RhcnRUaW1lID0gbnVsbDtcblxuICAgICAgICByZXR1cm4gdGltZXJPYnNlcnZhYmxlO1xuICAgIH1cbn1cbiJdfQ==